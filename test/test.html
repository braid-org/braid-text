<style>
    body {
        font-family: Arial, sans-serif;
        max-width: 800px;
        margin: 0 auto;
        padding: 10px;
    }
    .test {
        margin-bottom: 3px;
        padding: 3px;
    }
    .running {
        background-color: #fffde7;
    }
    .passed {
        background-color: #e8f5e9;
    }
    .failed {
        background-color: #ffebee;
    }
    #summaryContainer {
        display: flex;
        flex-wrap: wrap;
        gap: 5px;
        margin-bottom: 20px;
    }
    .summaryBox {
        width: 25px;
        height: 25px;
        border: 1px solid #ddd;
    }
</style>
<script src="https://unpkg.com/braid-http@~1.3/braid-http-client.js"></script>
<script src="./tests.js"></script>
<div id="summaryContainer"></div>
<div id="testContainer"></div>
<script type=module>

import {
    default as init,
    Doc,
    OpLog,
} from "https://unpkg.com/diamond-types-web";

// Make diamond-types available globally for tests.js
window.Doc = Doc
window.OpLog = OpLog
window.dt_p = init()

braid_fetch.enable_multiplex = false

// Parse URL parameters for filter
const urlParams = new URLSearchParams(window.location.search)
const filterArg = urlParams.get('filter') || urlParams.get('grep')

let delay = 0

function createTestDiv(testName) {
    const div = document.createElement("div")
    div.className = "test running"
    div.innerHTML = `<span style="font-weight:bold">${testName}: </span><span class="result">Running...</span>`
    testContainer.appendChild(div)
    return div
}

function updateTestResult(div, passed, message, got, expected) {
    div.className = `test ${passed ? "passed" : "failed"}`

    if (passed) {
        div.querySelector(".result").textContent = message
        div.querySelector(".result").style.fontSize = message.length > 400 ? 'xx-small' : message.length > 100 ? 'small' : ''
    } else {
        div.querySelector(".result").innerHTML = `${message}<br><strong>Got:</strong> ${got}<br><strong>Expected:</strong> ${expected}`
    }
}

function createSummaryBox() {
    var summaryContainer = document.getElementById('summaryContainer')
    const box = document.createElement('div');
    box.className = 'summaryBox running';
    summaryContainer.appendChild(box);
    return box;
}

function updateSummaryBox(box, passed) {
    box.className = `summaryBox ${passed ? 'passed' : passed === false ? 'failed' : 'other'}`;
}

async function runTest(testName, testFunction, expectedResult) {
    // Apply filter if specified
    if (filterArg && !testName.toLowerCase().includes(filterArg.toLowerCase())) {
        return // Skip this test
    }

    delay += 70

    await new Promise(done => setTimeout(done, delay))
    const div = createTestDiv(testName)
    const summaryBox = createSummaryBox()
    try {
        let x = await testFunction()
        if (x == expectedResult) {
            updateTestResult(div, true, x)
            updateSummaryBox(summaryBox, true)
        } else {
            updateTestResult(div, false, "Mismatch:", x, expectedResult)
            updateSummaryBox(summaryBox, false)
        }
    } catch (error) {
        updateTestResult(div, false, "Error:", error.message || error, expectedResult)
        updateSummaryBox(summaryBox, false)
    }
}

// Load and run all tests from the shared tests.js file
defineTests(runTest, braid_fetch)

</script>
